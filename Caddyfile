# MAI Framework V2 - Caddy Configuration
# Handles SSL termination and routing

# Shared configuration snippet
(mai_proxy) {
    encode gzip

    # Health check routes -> FastAPI backend
    handle /health {
        reverse_proxy mai-backend:8000
    }
    handle /health/* {
        reverse_proxy mai-backend:8000
    }

    # API routes -> FastAPI backend
    handle /api/* {
        reverse_proxy mai-backend:8000 {
            health_uri /health
            health_interval 30s
            health_timeout 5s
            header_up X-Real-IP {remote_host}
        }
    }

    # WebSocket support for streaming
    handle /ws/* {
        reverse_proxy mai-backend:8000
    }

    # All other routes -> React frontend
    handle {
        reverse_proxy mai-frontend:80
    }
}

# For local development (HTTP only)
http://localhost {
    import mai_proxy
}

# For Tailscale access (auto-HTTPS via MagicDNS)
# Set TAILSCALE_DOMAIN in .env.host (e.g., mai-studio.tailnet-name.ts.net)
# This block only activates when TAILSCALE_DOMAIN is set
{$TAILSCALE_DOMAIN:localhost}:443 {
    import mai_proxy
}
